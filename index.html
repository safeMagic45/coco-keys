<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Coco Keys">
    <meta name="theme-color" content="#0a0a0f">
    <title>Coco Keys</title>
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192.png">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@300;500;700&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }
        
        :root {
            --bg-dark: #0a0a0f;
            --bg-gradient: linear-gradient(180deg, #0a0a0f 0%, #1a1a2e 50%, #0a0a0f 100%);
            --neon-cyan: #00f5ff;
            --neon-pink: #ff00aa;
            --neon-purple: #9d00ff;
            --neon-green: #00ff88;
            --neon-yellow: #ffee00;
            --lane-1: #ff00aa;
            --lane-2: #00f5ff;
            --lane-3: #9d00ff;
            --lane-4: #00ff88;
            --white: #ffffff;
            --gray: #2a2a3e;
            --safe-top: env(safe-area-inset-top, 0px);
            --safe-bottom: env(safe-area-inset-bottom, 0px);
        }
        
        html, body {
            height: 100%;
            overflow: hidden;
            background: var(--bg-dark);
            font-family: 'Rajdhani', sans-serif;
            color: var(--white);
            touch-action: manipulation;
        }
        
        body {
            padding-top: var(--safe-top);
            padding-bottom: var(--safe-bottom);
        }
        
        /* ========== MENU SCREEN ========== */
        #menu-screen {
            position: fixed;
            inset: 0;
            background: var(--bg-gradient);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 100;
            padding: 20px;
            padding-top: calc(20px + var(--safe-top));
        }
        
        #menu-screen.hidden {
            display: none;
        }
        
        .menu-title {
            font-family: 'Orbitron', monospace;
            font-size: clamp(2.5rem, 8vw, 4.5rem);
            font-weight: 900;
            text-align: center;
            margin-bottom: 10px;
            background: linear-gradient(135deg, var(--neon-cyan), var(--neon-pink), var(--neon-purple));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: titlePulse 3s ease-in-out infinite;
        }
        
        @keyframes titlePulse {
            0%, 100% { filter: brightness(1); }
            50% { filter: brightness(1.2); }
        }
        
        .menu-subtitle {
            font-size: clamp(1rem, 3vw, 1.3rem);
            color: rgba(255, 255, 255, 0.6);
            margin-bottom: 40px;
            letter-spacing: 4px;
            text-transform: uppercase;
        }
        
        .song-list {
            width: 100%;
            max-width: 500px;
            max-height: 50vh;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            padding: 10px;
        }
        
        .song-card {
            background: linear-gradient(135deg, rgba(255,255,255,0.05) 0%, rgba(255,255,255,0.02) 100%);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.15s ease;
            position: relative;
            overflow: hidden;
            touch-action: manipulation;
        }
        
        .song-card.tapped {
            transform: scale(0.97);
            background: linear-gradient(135deg, rgba(0,245,255,0.15) 0%, rgba(255,0,170,0.1) 100%);
        }
        
        .song-card-content {
            position: relative;
            z-index: 1;
            pointer-events: none;
        }
        
        .song-name {
            font-family: 'Orbitron', monospace;
            font-size: 1.3rem;
            font-weight: 700;
            margin-bottom: 5px;
        }
        
        .song-composer {
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.5);
            margin-bottom: 10px;
        }
        
        .song-meta {
            display: flex;
            gap: 15px;
            font-size: 0.85rem;
        }
        
        .difficulty {
            padding: 4px 12px;
            border-radius: 20px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .difficulty.easy {
            background: rgba(0, 255, 136, 0.2);
            color: var(--neon-green);
            border: 1px solid var(--neon-green);
        }
        
        .difficulty.medium {
            background: rgba(255, 238, 0, 0.2);
            color: var(--neon-yellow);
            border: 1px solid var(--neon-yellow);
        }
        
        .difficulty.hard {
            background: rgba(255, 0, 170, 0.2);
            color: var(--neon-pink);
            border: 1px solid var(--neon-pink);
        }
        
        .bpm {
            color: rgba(255, 255, 255, 0.4);
        }
        
        .high-score {
            color: var(--neon-cyan);
            font-weight: 700;
        }
        
        /* ========== GAME SCREEN ========== */
        #game-screen {
            position: fixed;
            inset: 0;
            background: var(--bg-dark);
            display: none;
            flex-direction: column;
        }
        
        #game-screen.active {
            display: flex;
        }
        
        .game-header {
            height: 80px;
            padding: 15px 20px;
            padding-top: calc(15px + var(--safe-top));
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(180deg, rgba(0,0,0,0.8) 0%, transparent 100%);
            position: relative;
            z-index: 10;
        }
        
        .score-display {
            font-family: 'Orbitron', monospace;
            font-size: 2rem;
            font-weight: 900;
            color: var(--neon-cyan);
            text-shadow: 0 0 20px rgba(0, 245, 255, 0.5);
        }
        
        .combo-display {
            font-family: 'Orbitron', monospace;
            font-size: 1.2rem;
            color: var(--neon-pink);
            opacity: 0;
            transition: opacity 0.2s;
        }
        
        .combo-display.active {
            opacity: 1;
        }
        
        .pause-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.2);
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            touch-action: manipulation;
        }
        
        .game-area {
            flex: 1;
            position: relative;
            overflow: hidden;
        }
        
        .lanes-container {
            display: flex;
            height: 100%;
            position: relative;
        }
        
        .lane {
            flex: 1;
            position: relative;
            border-right: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .lane:last-child {
            border-right: none;
        }
        
        .lane-glow {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 120px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.1s;
        }
        
        .lane:nth-child(1) .lane-glow { background: linear-gradient(to top, rgba(255, 0, 170, 0.4), transparent); }
        .lane:nth-child(2) .lane-glow { background: linear-gradient(to top, rgba(0, 245, 255, 0.4), transparent); }
        .lane:nth-child(3) .lane-glow { background: linear-gradient(to top, rgba(157, 0, 255, 0.4), transparent); }
        .lane:nth-child(4) .lane-glow { background: linear-gradient(to top, rgba(0, 255, 136, 0.4), transparent); }
        
        .lane.hit .lane-glow {
            opacity: 1;
        }
        
        .hit-line {
            position: absolute;
            bottom: 100px;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--lane-1), var(--lane-2), var(--lane-3), var(--lane-4));
            box-shadow: 0 0 20px rgba(0, 245, 255, 0.5);
            z-index: 5;
            pointer-events: none;
        }
        
        .hit-zone {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 150px;
            background: linear-gradient(to top, rgba(255, 255, 255, 0.05), transparent);
            display: flex;
            z-index: 10;
            touch-action: manipulation;
        }
        
        .hit-zone-lane {
            flex: 1;
            border-right: 1px solid rgba(255, 255, 255, 0.05);
            position: relative;
        }
        
        .hit-zone-lane:last-child {
            border-right: none;
        }
        
        .tile {
            position: absolute;
            left: 2px;
            right: 2px;
            border-radius: 8px;
            pointer-events: none;
        }
        
        .tile.lane-0 { background: linear-gradient(180deg, var(--lane-1), #cc0088); box-shadow: 0 0 15px rgba(255, 0, 170, 0.5); }
        .tile.lane-1 { background: linear-gradient(180deg, var(--lane-2), #00bbcc); box-shadow: 0 0 15px rgba(0, 245, 255, 0.5); }
        .tile.lane-2 { background: linear-gradient(180deg, var(--lane-3), #7700cc); box-shadow: 0 0 15px rgba(157, 0, 255, 0.5); }
        .tile.lane-3 { background: linear-gradient(180deg, var(--lane-4), #00cc66); box-shadow: 0 0 15px rgba(0, 255, 136, 0.5); }
        
        .tile.hit {
            animation: tileHit 0.2s ease-out forwards;
        }
        
        @keyframes tileHit {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.1); }
            100% { transform: scale(0.8); opacity: 0; }
        }
        
        .tile.missed {
            background: #ff3333 !important;
            box-shadow: 0 0 20px rgba(255, 51, 51, 0.8) !important;
        }
        
        /* ========== PAUSE OVERLAY ========== */
        #pause-overlay {
            position: fixed;
            inset: 0;
            background: rgba(10, 10, 15, 0.95);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 50;
        }
        
        #pause-overlay.active {
            display: flex;
        }
        
        .pause-title {
            font-family: 'Orbitron', monospace;
            font-size: 3rem;
            margin-bottom: 40px;
            color: var(--neon-cyan);
        }
        
        .pause-btn-group {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .menu-button {
            font-family: 'Orbitron', monospace;
            font-size: 1.2rem;
            padding: 18px 50px;
            border-radius: 30px;
            border: 2px solid;
            background: transparent;
            cursor: pointer;
            transition: all 0.2s ease;
            text-transform: uppercase;
            letter-spacing: 2px;
            touch-action: manipulation;
        }
        
        .menu-button.primary {
            border-color: var(--neon-cyan);
            color: var(--neon-cyan);
        }
        
        .menu-button.primary:active {
            background: var(--neon-cyan);
            color: var(--bg-dark);
        }
        
        .menu-button.secondary {
            border-color: var(--neon-pink);
            color: var(--neon-pink);
        }
        
        .menu-button.secondary:active {
            background: var(--neon-pink);
            color: var(--bg-dark);
        }
        
        /* ========== GAME OVER ========== */
        #gameover-overlay {
            position: fixed;
            inset: 0;
            background: rgba(10, 10, 15, 0.95);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 60;
        }
        
        #gameover-overlay.active {
            display: flex;
        }
        
        .gameover-title {
            font-family: 'Orbitron', monospace;
            font-size: 2.5rem;
            color: var(--neon-pink);
            margin-bottom: 10px;
            text-shadow: 0 0 30px rgba(255, 0, 170, 0.5);
        }
        
        .final-score {
            font-family: 'Orbitron', monospace;
            font-size: 4rem;
            font-weight: 900;
            color: var(--neon-cyan);
            margin-bottom: 10px;
        }
        
        .score-label {
            font-size: 1.2rem;
            color: rgba(255, 255, 255, 0.5);
            margin-bottom: 30px;
            text-transform: uppercase;
            letter-spacing: 3px;
        }
        
        .stats-row {
            display: flex;
            gap: 40px;
            margin-bottom: 40px;
        }
        
        .stat-item {
            text-align: center;
        }
        
        .stat-value {
            font-family: 'Orbitron', monospace;
            font-size: 2rem;
            font-weight: 700;
            color: var(--neon-green);
        }
        
        .stat-label {
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.4);
            text-transform: uppercase;
        }
        
        .new-record {
            font-family: 'Orbitron', monospace;
            font-size: 1.5rem;
            color: var(--neon-yellow);
            margin-bottom: 20px;
            animation: recordPulse 0.5s ease-in-out infinite alternate;
        }
        
        @keyframes recordPulse {
            from { opacity: 0.7; transform: scale(1); }
            to { opacity: 1; transform: scale(1.05); }
        }
        
        /* ========== COUNTDOWN ========== */
        #countdown {
            position: fixed;
            inset: 0;
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 70;
            background: rgba(10, 10, 15, 0.8);
        }
        
        #countdown.active {
            display: flex;
        }
        
        .countdown-number {
            font-family: 'Orbitron', monospace;
            font-size: 10rem;
            font-weight: 900;
            color: var(--neon-cyan);
            text-shadow: 0 0 60px rgba(0, 245, 255, 0.8);
            animation: countPop 0.5s ease-out;
        }
        
        @keyframes countPop {
            0% { transform: scale(2); opacity: 0; }
            50% { transform: scale(0.9); }
            100% { transform: scale(1); opacity: 1; }
        }
        
        /* ========== SCROLLBAR ========== */
        .song-list::-webkit-scrollbar {
            width: 6px;
        }
        
        .song-list::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 3px;
        }
        
        .song-list::-webkit-scrollbar-thumb {
            background: rgba(0, 245, 255, 0.3);
            border-radius: 3px;
        }
    </style>
</head>
<body>
    <!-- Menu Screen -->
    <div id="menu-screen">
        <h1 class="menu-title">COCO KEYS</h1>
        <p class="menu-subtitle">Tap to the Beat</p>
        <div class="song-list" id="song-list"></div>
    </div>
    
    <!-- Game Screen -->
    <div id="game-screen">
        <div class="game-header">
            <div>
                <div class="score-display" id="score">0</div>
                <div class="combo-display" id="combo">COMBO x1</div>
            </div>
            <button class="pause-btn" id="pause-btn">❚❚</button>
        </div>
        <div class="game-area" id="game-area">
            <div class="lanes-container" id="lanes-container">
                <div class="lane" data-lane="0"><div class="lane-glow"></div></div>
                <div class="lane" data-lane="1"><div class="lane-glow"></div></div>
                <div class="lane" data-lane="2"><div class="lane-glow"></div></div>
                <div class="lane" data-lane="3"><div class="lane-glow"></div></div>
            </div>
            <div class="hit-line"></div>
            <div class="hit-zone" id="hit-zone">
                <div class="hit-zone-lane" data-lane="0"></div>
                <div class="hit-zone-lane" data-lane="1"></div>
                <div class="hit-zone-lane" data-lane="2"></div>
                <div class="hit-zone-lane" data-lane="3"></div>
            </div>
        </div>
    </div>
    
    <!-- Pause Overlay -->
    <div id="pause-overlay">
        <h2 class="pause-title">PAUSED</h2>
        <div class="pause-btn-group">
            <button class="menu-button primary" id="resume-btn">RESUME</button>
            <button class="menu-button secondary" id="quit-btn">QUIT</button>
        </div>
    </div>
    
    <!-- Game Over Overlay -->
    <div id="gameover-overlay">
        <h2 class="gameover-title">GAME OVER</h2>
        <div class="final-score" id="final-score">0</div>
        <div class="score-label">FINAL SCORE</div>
        <div class="new-record" id="new-record" style="display: none;">★ NEW RECORD ★</div>
        <div class="stats-row">
            <div class="stat-item">
                <div class="stat-value" id="tiles-hit">0</div>
                <div class="stat-label">Tiles Hit</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="max-combo">0</div>
                <div class="stat-label">Max Combo</div>
            </div>
        </div>
        <div class="pause-btn-group">
            <button class="menu-button primary" id="retry-btn">RETRY</button>
            <button class="menu-button secondary" id="menu-btn">MENU</button>
        </div>
    </div>
    
    <!-- Countdown -->
    <div id="countdown">
        <div class="countdown-number" id="countdown-number">3</div>
    </div>

    <script>
        // ==================== AUDIO ENGINE ====================
        const AudioEngine = {
            ctx: null,
            initialized: false,
            
            init() {
                if (this.initialized && this.ctx) return;
                try {
                    this.ctx = new (window.AudioContext || window.webkitAudioContext)();
                    this.initialized = true;
                    if (this.ctx.state === 'suspended') {
                        this.ctx.resume();
                    }
                } catch(e) {
                    console.log('Audio not available');
                }
            },
            
            resume() {
                if (this.ctx && this.ctx.state === 'suspended') {
                    this.ctx.resume();
                }
            },
            
            getNoteFrequency(noteIndex) {
                const notes = [
                    261.63, 293.66, 329.63, 349.23, 392.00, 440.00, 493.88,
                    523.25, 587.33, 659.25, 698.46, 783.99, 880.00, 987.77,
                    1046.50
                ];
                return notes[noteIndex % notes.length];
            },
            
            playNote(noteIndex) {
                if (!this.ctx) return;
                this.resume();
                
                const freq = this.getNoteFrequency(noteIndex);
                const now = this.ctx.currentTime;
                
                const osc1 = this.ctx.createOscillator();
                const osc2 = this.ctx.createOscillator();
                const gainNode = this.ctx.createGain();
                
                osc1.type = 'triangle';
                osc1.frequency.value = freq;
                
                osc2.type = 'sine';
                osc2.frequency.value = freq * 2;
                
                gainNode.gain.setValueAtTime(0, now);
                gainNode.gain.linearRampToValueAtTime(0.3, now + 0.01);
                gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.3);
                
                osc1.connect(gainNode);
                osc2.connect(gainNode);
                gainNode.connect(this.ctx.destination);
                
                osc1.start(now);
                osc2.start(now);
                osc1.stop(now + 0.3);
                osc2.stop(now + 0.3);
            },
            
            playMiss() {
                if (!this.ctx) return;
                this.resume();
                
                const now = this.ctx.currentTime;
                const osc = this.ctx.createOscillator();
                const gainNode = this.ctx.createGain();
                
                osc.type = 'sawtooth';
                osc.frequency.value = 80;
                
                gainNode.gain.setValueAtTime(0.2, now);
                gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.2);
                
                osc.connect(gainNode);
                gainNode.connect(this.ctx.destination);
                
                osc.start(now);
                osc.stop(now + 0.2);
            }
        };
        
        // ==================== SONG DATA ====================
        const SONGS = [
            {
                id: 'twinkle',
                name: 'Twinkle Twinkle',
                composer: 'Traditional',
                difficulty: 'easy',
                bpm: 100,
                notes: [
                    [0, 0, 0], [0, 1, 0], [2, 2, 4], [2, 3, 4],
                    [3, 4, 5], [3, 5, 5], [2, 6, 4], 
                    [1, 8, 3], [1, 9, 3], [0, 10, 2], [0, 11, 2],
                    [3, 12, 1], [3, 13, 1], [2, 14, 0],
                    [2, 16, 4], [2, 17, 4], [1, 18, 3], [1, 19, 3],
                    [0, 20, 2], [0, 21, 2], [3, 22, 1],
                    [2, 24, 4], [2, 25, 4], [1, 26, 3], [1, 27, 3],
                    [0, 28, 2], [0, 29, 2], [3, 30, 1],
                    [0, 32, 0], [0, 33, 0], [2, 34, 4], [2, 35, 4],
                    [3, 36, 5], [3, 37, 5], [2, 38, 4]
                ]
            },
            {
                id: 'ode_to_joy',
                name: 'Ode to Joy',
                composer: 'Beethoven',
                difficulty: 'easy',
                bpm: 110,
                notes: [
                    [1, 0, 4], [1, 1, 4], [2, 2, 5], [3, 3, 6],
                    [3, 4, 6], [2, 5, 5], [1, 6, 4], [0, 7, 3],
                    [0, 8, 2], [0, 9, 2], [1, 10, 3], [1, 11, 4],
                    [1, 12, 4], [0, 13.5, 3], [0, 14, 3],
                    [1, 16, 4], [1, 17, 4], [2, 18, 5], [3, 19, 6],
                    [3, 20, 6], [2, 21, 5], [1, 22, 4], [0, 23, 3],
                    [0, 24, 2], [0, 25, 2], [1, 26, 3], [1, 27, 4],
                    [0, 28, 3], [0, 29.5, 2], [0, 30, 2]
                ]
            },
            {
                id: 'mary_lamb',
                name: 'Mary Had a Little Lamb',
                composer: 'Traditional',
                difficulty: 'easy',
                bpm: 100,
                notes: [
                    [2, 0, 4], [1, 1, 3], [0, 2, 2], [1, 3, 3],
                    [2, 4, 4], [2, 5, 4], [2, 6, 4],
                    [1, 8, 3], [1, 9, 3], [1, 10, 3],
                    [2, 12, 4], [3, 13, 6], [3, 14, 6],
                    [2, 16, 4], [1, 17, 3], [0, 18, 2], [1, 19, 3],
                    [2, 20, 4], [2, 21, 4], [2, 22, 4], [2, 23, 4],
                    [1, 24, 3], [1, 25, 3], [2, 26, 4], [1, 27, 3],
                    [0, 28, 2]
                ]
            },
            {
                id: 'jingle_bells',
                name: 'Jingle Bells',
                composer: 'Traditional',
                difficulty: 'easy',
                bpm: 120,
                notes: [
                    [2, 0, 4], [2, 1, 4], [2, 2, 4],
                    [2, 4, 4], [2, 5, 4], [2, 6, 4],
                    [2, 8, 4], [3, 9, 6], [0, 10, 0], [1, 11, 2],
                    [2, 12, 4],
                    [1, 14, 3], [1, 15, 3], [1, 16, 3], [1, 17, 3],
                    [1, 18, 3], [2, 19, 4], [2, 20, 4], [2, 21, 4],
                    [2, 22, 4], [1, 23, 2], [1, 24, 2], [3, 25, 6],
                    [3, 26, 6], [1, 27, 2], [0, 28, 0]
                ]
            },
            {
                id: 'fur_elise',
                name: 'Für Elise',
                composer: 'Beethoven',
                difficulty: 'medium',
                bpm: 130,
                notes: [
                    [3, 0, 9], [2, 0.5, 8], [3, 1, 9], [2, 1.5, 8], [3, 2, 9],
                    [1, 2.5, 6], [2, 3, 8], [0, 3.5, 5], [0, 4, 4],
                    [0, 5, 0], [1, 5.5, 2], [0, 6, 4], [1, 6.5, 6],
                    [2, 7, 8], [1, 8, 4], [2, 8.5, 7], [1, 9, 6],
                    [2, 9.5, 8], [3, 10, 9], [2, 10.5, 8], [3, 11, 9],
                    [2, 11.5, 8], [3, 12, 9], [1, 12.5, 6], [2, 13, 8],
                    [0, 13.5, 5], [0, 14, 4]
                ]
            },
            {
                id: 'canon',
                name: 'Canon in D',
                composer: 'Pachelbel',
                difficulty: 'medium',
                bpm: 80,
                notes: [
                    [3, 0, 11], [2, 1, 9], [1, 2, 7], [0, 3, 4],
                    [0, 4, 2], [1, 5, 4], [2, 6, 7], [3, 7, 9],
                    [3, 8, 11], [3, 9, 11], [2, 10, 9], [2, 11, 9],
                    [1, 12, 7], [1, 13, 7], [0, 14, 4], [0, 15, 4],
                    [0, 16, 2], [0, 17, 2], [1, 18, 4], [1, 19, 4],
                    [2, 20, 7], [2, 21, 7], [3, 22, 9], [3, 23, 9]
                ]
            },
            {
                id: 'entertainer',
                name: 'The Entertainer',
                composer: 'Scott Joplin',
                difficulty: 'hard',
                bpm: 150,
                notes: [
                    [2, 0, 3], [3, 0.5, 4], [2, 1, 3], [3, 1.5, 4],
                    [2, 2, 3], [1, 2.5, 0], [0, 3, 2], [1, 3.5, 3],
                    [2, 4, 4], [1, 5, 3], [0, 6, 2], [1, 6.5, 3],
                    [2, 7, 4], [3, 7.5, 7], [3, 8, 6], [2, 8.5, 4],
                    [1, 9, 3], [2, 9.5, 4], [3, 10, 6], [2, 10.5, 4],
                    [1, 11, 3], [0, 11.5, 2], [0, 12, 0],
                    [2, 13, 3], [3, 13.5, 4], [2, 14, 3], [3, 14.5, 4],
                    [2, 15, 3], [1, 15.5, 0], [0, 16, 2]
                ]
            },
            {
                id: 'moonlight',
                name: 'Moonlight Sonata',
                composer: 'Beethoven',
                difficulty: 'hard',
                bpm: 140,
                notes: [
                    [0, 0, 0], [1, 0.33, 4], [2, 0.66, 7],
                    [0, 1, 0], [1, 1.33, 4], [2, 1.66, 7],
                    [0, 2, 0], [1, 2.33, 4], [2, 2.66, 7],
                    [0, 3, 0], [1, 3.33, 4], [2, 3.66, 7],
                    [3, 4, 8], [1, 4.33, 4], [2, 4.66, 7],
                    [3, 5, 9], [1, 5.33, 4], [2, 5.66, 7],
                    [3, 6, 8], [1, 6.33, 4], [2, 6.66, 7],
                    [0, 7, 0], [1, 7.33, 4], [2, 7.66, 7]
                ]
            }
        ];
        
        // ==================== GAME STATE ====================
        const Game = {
            currentSong: null,
            tiles: [],
            score: 0,
            combo: 0,
            maxCombo: 0,
            tilesHit: 0,
            isPlaying: false,
            isPaused: false,
            gameOver: false,
            startTime: 0,
            tileSpeed: 400,
            tileHeight: 100,
            hitZoneTop: 0,
            hitZoneBottom: 0,
            nextTileIndex: 0,
            lastFrameTime: 0,
            animationId: null,
            highScores: {},
            els: {}
        };
        
        // ==================== HELPER: TAP HANDLER ====================
        function addTapHandler(element, callback) {
            let startY = 0;
            let startTime = 0;
            
            element.addEventListener('touchstart', function(e) {
                startY = e.touches[0].clientY;
                startTime = Date.now();
            }, { passive: true });
            
            element.addEventListener('touchend', function(e) {
                const endY = e.changedTouches[0].clientY;
                const endTime = Date.now();
                const deltaY = Math.abs(endY - startY);
                const deltaTime = endTime - startTime;
                
                if (deltaY < 30 && deltaTime < 300) {
                    e.preventDefault();
                    callback(e);
                }
            }, { passive: false });
            
            element.addEventListener('click', callback);
        }
        
        // ==================== INITIALIZATION ====================
        function init() {
            Game.els = {
                menuScreen: document.getElementById('menu-screen'),
                gameScreen: document.getElementById('game-screen'),
                pauseOverlay: document.getElementById('pause-overlay'),
                gameoverOverlay: document.getElementById('gameover-overlay'),
                countdown: document.getElementById('countdown'),
                countdownNumber: document.getElementById('countdown-number'),
                scoreDisplay: document.getElementById('score'),
                comboDisplay: document.getElementById('combo'),
                finalScore: document.getElementById('final-score'),
                tilesHitDisplay: document.getElementById('tiles-hit'),
                maxComboDisplay: document.getElementById('max-combo'),
                newRecord: document.getElementById('new-record'),
                gameArea: document.getElementById('game-area'),
                lanesContainer: document.getElementById('lanes-container'),
                hitZone: document.getElementById('hit-zone'),
                lanes: document.querySelectorAll('.lane'),
                songList: document.getElementById('song-list')
            };
            
            loadHighScores();
            renderSongList();
            setupEventListeners();
        }
        
        function loadHighScores() {
            try {
                Game.highScores = JSON.parse(localStorage.getItem('cocoKeysHighScores') || '{}');
            } catch(e) {
                Game.highScores = {};
            }
        }
        
        function saveHighScore(songId, score) {
            if (score > (Game.highScores[songId] || 0)) {
                Game.highScores[songId] = score;
                try {
                    localStorage.setItem('cocoKeysHighScores', JSON.stringify(Game.highScores));
                } catch(e) {}
                return true;
            }
            return false;
        }
        
        function renderSongList() {
            Game.els.songList.innerHTML = SONGS.map(song => {
                const highScore = Game.highScores[song.id] || 0;
                return `
                    <div class="song-card" data-song-id="${song.id}">
                        <div class="song-card-content">
                            <div class="song-name">${song.name}</div>
                            <div class="song-composer">${song.composer}</div>
                            <div class="song-meta">
                                <span class="difficulty ${song.difficulty}">${song.difficulty}</span>
                                <span class="bpm">${song.bpm} BPM</span>
                                ${highScore > 0 ? `<span class="high-score">★ ${highScore}</span>` : ''}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            document.querySelectorAll('.song-card').forEach(card => {
                addTapHandler(card, function() {
                    const songId = card.dataset.songId;
                    card.classList.add('tapped');
                    setTimeout(() => card.classList.remove('tapped'), 150);
                    startGame(songId);
                });
            });
        }
        
        function setupEventListeners() {
            Game.els.hitZone.addEventListener('touchstart', handleHitZoneTouch, { passive: false });
            Game.els.hitZone.addEventListener('mousedown', handleHitZoneClick);
            
            addTapHandler(document.getElementById('pause-btn'), togglePause);
            addTapHandler(document.getElementById('resume-btn'), togglePause);
            addTapHandler(document.getElementById('quit-btn'), quitGame);
            addTapHandler(document.getElementById('retry-btn'), retryGame);
            addTapHandler(document.getElementById('menu-btn'), quitGame);
            
            document.body.addEventListener('touchmove', function(e) {
                if (Game.isPlaying) {
                    e.preventDefault();
                }
            }, { passive: false });
        }
        
        // ==================== GAME FUNCTIONS ====================
        async function startGame(songId) {
            AudioEngine.init();
            
            Game.currentSong = SONGS.find(s => s.id === songId);
            if (!Game.currentSong) return;
            
            Game.score = 0;
            Game.combo = 0;
            Game.maxCombo = 0;
            Game.tilesHit = 0;
            Game.tiles = [];
            Game.nextTileIndex = 0;
            Game.gameOver = false;
            Game.isPaused = false;
            
            const gameAreaRect = Game.els.gameArea.getBoundingClientRect();
            Game.hitZoneTop = gameAreaRect.height - 150;
            Game.hitZoneBottom = gameAreaRect.height;
            
            Game.tileSpeed = (Game.currentSong.bpm / 60) * 180;
            
            Game.els.menuScreen.classList.add('hidden');
            Game.els.gameScreen.classList.add('active');
            
            updateScore();
            updateCombo();
            
            Game.els.lanesContainer.querySelectorAll('.tile').forEach(t => t.remove());
            
            await showCountdown();
            
            Game.isPlaying = true;
            Game.startTime = performance.now();
            Game.lastFrameTime = Game.startTime;
            gameLoop();
        }
        
        async function showCountdown() {
            Game.els.countdown.classList.add('active');
            
            for (let i = 3; i >= 1; i--) {
                Game.els.countdownNumber.textContent = i;
                Game.els.countdownNumber.style.animation = 'none';
                Game.els.countdownNumber.offsetHeight;
                Game.els.countdownNumber.style.animation = 'countPop 0.5s ease-out';
                await delay(700);
            }
            
            Game.els.countdownNumber.textContent = 'GO!';
            Game.els.countdownNumber.style.color = 'var(--neon-green)';
            await delay(500);
            
            Game.els.countdown.classList.remove('active');
            Game.els.countdownNumber.style.color = 'var(--neon-cyan)';
        }
        
        function delay(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }
        
        function gameLoop() {
            if (!Game.isPlaying || Game.gameOver) return;
            if (Game.isPaused) {
                Game.animationId = requestAnimationFrame(gameLoop);
                return;
            }
            
            const now = performance.now();
            const deltaTime = (now - Game.lastFrameTime) / 1000;
            Game.lastFrameTime = now;
            
            const elapsedTime = (now - Game.startTime) / 1000;
            const beatTime = Game.currentSong.bpm / 60;
            
            spawnTiles(elapsedTime, beatTime);
            updateTiles(deltaTime);
            checkMissedTiles();
            
            if (Game.nextTileIndex >= Game.currentSong.notes.length && Game.tiles.length === 0) {
                endGame(true);
                return;
            }
            
            Game.animationId = requestAnimationFrame(gameLoop);
        }
        
        function spawnTiles(elapsedTime, beatTime) {
            const gameAreaRect = Game.els.gameArea.getBoundingClientRect();
            const spawnY = -Game.tileHeight;
            const travelDistance = gameAreaRect.height;
            const travelTime = travelDistance / Game.tileSpeed;
            
            while (Game.nextTileIndex < Game.currentSong.notes.length) {
                const note = Game.currentSong.notes[Game.nextTileIndex];
                const noteTime = note[1] / beatTime;
                const spawnTime = noteTime - travelTime + (Game.hitZoneTop / Game.tileSpeed);
                
                if (elapsedTime >= spawnTime) {
                    const tile = {
                        id: Game.nextTileIndex,
                        lane: note[0],
                        noteIndex: note[2],
                        y: spawnY,
                        hit: false,
                        missed: false,
                        element: createTileElement(note[0])
                    };
                    Game.tiles.push(tile);
                    Game.nextTileIndex++;
                } else {
                    break;
                }
            }
        }
        
        function createTileElement(lane) {
            const tile = document.createElement('div');
            tile.className = `tile lane-${lane}`;
            tile.style.height = `${Game.tileHeight}px`;
            Game.els.lanes[lane].appendChild(tile);
            return tile;
        }
        
        function updateTiles(deltaTime) {
            const movement = Game.tileSpeed * deltaTime;
            
            Game.tiles.forEach(tile => {
                if (!tile.hit && !tile.missed) {
                    tile.y += movement;
                    tile.element.style.top = `${tile.y}px`;
                }
            });
        }
        
        function checkMissedTiles() {
            Game.tiles.forEach(tile => {
                if (!tile.hit && !tile.missed && tile.y > Game.hitZoneBottom) {
                    missTile(tile);
                }
            });
        }
        
        function handleHitZoneTouch(e) {
            if (!Game.isPlaying || Game.isPaused || Game.gameOver) return;
            e.preventDefault();
            
            AudioEngine.resume();
            
            Array.from(e.touches).forEach(touch => {
                const lane = getLaneFromPosition(touch.clientX);
                if (lane !== -1) {
                    tryHitTile(lane);
                }
            });
        }
        
        function handleHitZoneClick(e) {
            if (!Game.isPlaying || Game.isPaused || Game.gameOver) return;
            
            AudioEngine.resume();
            
            const lane = getLaneFromPosition(e.clientX);
            if (lane !== -1) {
                tryHitTile(lane);
            }
        }
        
        function getLaneFromPosition(x) {
            const hitZoneRect = Game.els.hitZone.getBoundingClientRect();
            const relativeX = x - hitZoneRect.left;
            const laneWidth = hitZoneRect.width / 4;
            const lane = Math.floor(relativeX / laneWidth);
            return lane >= 0 && lane < 4 ? lane : -1;
        }
        
        function tryHitTile(lane) {
            const hitTile = Game.tiles
                .filter(t => t.lane === lane && !t.hit && !t.missed)
                .filter(t => t.y + Game.tileHeight > Game.hitZoneTop - 50 && t.y < Game.hitZoneBottom)
                .sort((a, b) => b.y - a.y)[0];
            
            if (hitTile) {
                hitTile.hit = true;
                hitTile.element.classList.add('hit');
                
                AudioEngine.playNote(hitTile.noteIndex);
                
                Game.combo++;
                Game.maxCombo = Math.max(Game.maxCombo, Game.combo);
                Game.tilesHit++;
                
                const comboMultiplier = Math.min(1 + Math.floor(Game.combo / 10) * 0.5, 3);
                Game.score += Math.floor(100 * comboMultiplier);
                
                updateScore();
                updateCombo();
                
                setTimeout(() => {
                    hitTile.element.remove();
                    const idx = Game.tiles.indexOf(hitTile);
                    if (idx > -1) Game.tiles.splice(idx, 1);
                }, 200);
            }
            
            Game.els.lanes[lane].classList.add('hit');
            setTimeout(() => Game.els.lanes[lane].classList.remove('hit'), 100);
        }
        
        function missTile(tile) {
            tile.missed = true;
            tile.element.classList.add('missed');
            
            AudioEngine.playMiss();
            Game.combo = 0;
            updateCombo();
            
            endGame(false);
        }
        
        function updateScore() {
            Game.els.scoreDisplay.textContent = Game.score;
        }
        
        function updateCombo() {
            if (Game.combo > 1) {
                Game.els.comboDisplay.textContent = `COMBO x${Game.combo}`;
                Game.els.comboDisplay.classList.add('active');
            } else {
                Game.els.comboDisplay.classList.remove('active');
            }
        }
        
        function togglePause() {
            Game.isPaused = !Game.isPaused;
            Game.els.pauseOverlay.classList.toggle('active', Game.isPaused);
            
            if (!Game.isPaused) {
                Game.lastFrameTime = performance.now();
            }
        }
        
        function endGame(completed) {
            Game.isPlaying = false;
            Game.gameOver = true;
            
            if (Game.animationId) {
                cancelAnimationFrame(Game.animationId);
            }
            
            const isNewRecord = saveHighScore(Game.currentSong.id, Game.score);
            
            Game.els.finalScore.textContent = Game.score;
            Game.els.tilesHitDisplay.textContent = Game.tilesHit;
            Game.els.maxComboDisplay.textContent = Game.maxCombo;
            Game.els.newRecord.style.display = isNewRecord ? 'block' : 'none';
            
            setTimeout(() => {
                Game.els.gameoverOverlay.classList.add('active');
            }, 500);
        }
        
        function retryGame() {
            Game.els.gameoverOverlay.classList.remove('active');
            Game.els.lanesContainer.querySelectorAll('.tile').forEach(t => t.remove());
            startGame(Game.currentSong.id);
        }
        
        function quitGame() {
            Game.isPlaying = false;
            Game.gameOver = true;
            
            if (Game.animationId) {
                cancelAnimationFrame(Game.animationId);
            }
            
            Game.els.gameScreen.classList.remove('active');
            Game.els.pauseOverlay.classList.remove('active');
            Game.els.gameoverOverlay.classList.remove('active');
            Game.els.menuScreen.classList.remove('hidden');
            
            Game.els.lanesContainer.querySelectorAll('.tile').forEach(t => t.remove());
            renderSongList();
        }
        
        // Start the app when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
    </script>
</body>
</html>
