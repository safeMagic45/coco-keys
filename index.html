<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Coco Keys">
    <meta name="theme-color" content="#0a0a0f">
    <title>Coco Keys</title>
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192.png">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@300;500;700&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }
        
        :root {
            --bg-dark: #0a0a0f;
            --bg-gradient: linear-gradient(180deg, #0a0a0f 0%, #1a1a2e 50%, #0a0a0f 100%);
            --neon-cyan: #00f5ff;
            --neon-pink: #ff00aa;
            --neon-purple: #9d00ff;
            --neon-green: #00ff88;
            --neon-yellow: #ffee00;
            --lane-1: #ff00aa;
            --lane-2: #00f5ff;
            --lane-3: #9d00ff;
            --lane-4: #00ff88;
            --white: #ffffff;
            --gray: #2a2a3e;
            --safe-top: env(safe-area-inset-top, 0px);
            --safe-bottom: env(safe-area-inset-bottom, 0px);
        }
        
        html, body {
            height: 100%;
            overflow: hidden;
            background: var(--bg-dark);
            font-family: 'Rajdhani', sans-serif;
            color: var(--white);
        }
        
        body {
            padding-top: var(--safe-top);
            padding-bottom: var(--safe-bottom);
        }
        
        /* ========== MENU SCREEN ========== */
        #menu-screen {
            position: fixed;
            inset: 0;
            background: var(--bg-gradient);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 100;
            padding: 20px;
        }
        
        #menu-screen.hidden {
            display: none;
        }
        
        .menu-title {
            font-family: 'Orbitron', monospace;
            font-size: clamp(2.5rem, 8vw, 4.5rem);
            font-weight: 900;
            text-align: center;
            margin-bottom: 10px;
            background: linear-gradient(135deg, var(--neon-cyan), var(--neon-pink), var(--neon-purple));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: 0 0 40px rgba(0, 245, 255, 0.3);
            animation: titlePulse 3s ease-in-out infinite;
        }
        
        @keyframes titlePulse {
            0%, 100% { filter: brightness(1); }
            50% { filter: brightness(1.2); }
        }
        
        .menu-subtitle {
            font-size: clamp(1rem, 3vw, 1.3rem);
            color: rgba(255, 255, 255, 0.6);
            margin-bottom: 40px;
            letter-spacing: 4px;
            text-transform: uppercase;
        }
        
        .song-list {
            width: 100%;
            max-width: 500px;
            max-height: 50vh;
            overflow-y: auto;
            padding: 10px;
        }
        
        .song-card {
            background: linear-gradient(135deg, rgba(255,255,255,0.05) 0%, rgba(255,255,255,0.02) 100%);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .song-card::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(135deg, var(--neon-cyan), var(--neon-pink));
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .song-card:hover::before,
        .song-card:active::before {
            opacity: 0.1;
        }
        
        .song-card:active {
            transform: scale(0.98);
        }
        
        .song-card-content {
            position: relative;
            z-index: 1;
        }
        
        .song-name {
            font-family: 'Orbitron', monospace;
            font-size: 1.3rem;
            font-weight: 700;
            margin-bottom: 5px;
        }
        
        .song-composer {
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.5);
            margin-bottom: 10px;
        }
        
        .song-meta {
            display: flex;
            gap: 15px;
            font-size: 0.85rem;
        }
        
        .difficulty {
            padding: 4px 12px;
            border-radius: 20px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .difficulty.easy {
            background: rgba(0, 255, 136, 0.2);
            color: var(--neon-green);
            border: 1px solid var(--neon-green);
        }
        
        .difficulty.medium {
            background: rgba(255, 238, 0, 0.2);
            color: var(--neon-yellow);
            border: 1px solid var(--neon-yellow);
        }
        
        .difficulty.hard {
            background: rgba(255, 0, 170, 0.2);
            color: var(--neon-pink);
            border: 1px solid var(--neon-pink);
        }
        
        .bpm {
            color: rgba(255, 255, 255, 0.4);
        }
        
        .high-score {
            color: var(--neon-cyan);
            font-weight: 700;
        }
        
        /* ========== GAME SCREEN ========== */
        #game-screen {
            position: fixed;
            inset: 0;
            background: var(--bg-dark);
            display: none;
            flex-direction: column;
        }
        
        #game-screen.active {
            display: flex;
        }
        
        .game-header {
            height: 80px;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(180deg, rgba(0,0,0,0.8) 0%, transparent 100%);
            position: relative;
            z-index: 10;
        }
        
        .score-display {
            font-family: 'Orbitron', monospace;
            font-size: 2rem;
            font-weight: 900;
            color: var(--neon-cyan);
            text-shadow: 0 0 20px rgba(0, 245, 255, 0.5);
        }
        
        .combo-display {
            font-family: 'Orbitron', monospace;
            font-size: 1.2rem;
            color: var(--neon-pink);
            opacity: 0;
            transition: opacity 0.2s;
        }
        
        .combo-display.active {
            opacity: 1;
        }
        
        .pause-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.2);
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .game-area {
            flex: 1;
            position: relative;
            overflow: hidden;
        }
        
        .lanes-container {
            display: flex;
            height: 100%;
            position: relative;
        }
        
        .lane {
            flex: 1;
            position: relative;
            border-right: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .lane:last-child {
            border-right: none;
        }
        
        .lane-glow {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 120px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.1s;
        }
        
        .lane:nth-child(1) .lane-glow { background: linear-gradient(to top, rgba(255, 0, 170, 0.4), transparent); }
        .lane:nth-child(2) .lane-glow { background: linear-gradient(to top, rgba(0, 245, 255, 0.4), transparent); }
        .lane:nth-child(3) .lane-glow { background: linear-gradient(to top, rgba(157, 0, 255, 0.4), transparent); }
        .lane:nth-child(4) .lane-glow { background: linear-gradient(to top, rgba(0, 255, 136, 0.4), transparent); }
        
        .lane.hit .lane-glow {
            opacity: 1;
        }
        
        .hit-line {
            position: absolute;
            bottom: 100px;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--lane-1), var(--lane-2), var(--lane-3), var(--lane-4));
            box-shadow: 0 0 20px rgba(0, 245, 255, 0.5);
            z-index: 5;
        }
        
        .hit-zone {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 100px;
            background: linear-gradient(to top, rgba(255, 255, 255, 0.05), transparent);
            display: flex;
        }
        
        .hit-zone-lane {
            flex: 1;
            border-right: 1px solid rgba(255, 255, 255, 0.05);
            position: relative;
        }
        
        .hit-zone-lane:last-child {
            border-right: none;
        }
        
        .tile {
            position: absolute;
            left: 2px;
            right: 2px;
            border-radius: 8px;
            transition: transform 0.05s;
        }
        
        .tile.lane-0 { background: linear-gradient(180deg, var(--lane-1), #cc0088); box-shadow: 0 0 15px rgba(255, 0, 170, 0.5); }
        .tile.lane-1 { background: linear-gradient(180deg, var(--lane-2), #00bbcc); box-shadow: 0 0 15px rgba(0, 245, 255, 0.5); }
        .tile.lane-2 { background: linear-gradient(180deg, var(--lane-3), #7700cc); box-shadow: 0 0 15px rgba(157, 0, 255, 0.5); }
        .tile.lane-3 { background: linear-gradient(180deg, var(--lane-4), #00cc66); box-shadow: 0 0 15px rgba(0, 255, 136, 0.5); }
        
        .tile.hit {
            animation: tileHit 0.2s ease-out forwards;
        }
        
        @keyframes tileHit {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.1); }
            100% { transform: scale(0.8); opacity: 0; }
        }
        
        .tile.missed {
            background: #ff3333 !important;
            box-shadow: 0 0 20px rgba(255, 51, 51, 0.8) !important;
        }
        
        .hit-effect {
            position: absolute;
            width: 100%;
            height: 60px;
            bottom: 100px;
            pointer-events: none;
            opacity: 0;
        }
        
        .hit-effect.show {
            animation: hitFlash 0.3s ease-out;
        }
        
        @keyframes hitFlash {
            0% { opacity: 1; transform: scaleY(1); }
            100% { opacity: 0; transform: scaleY(2); }
        }
        
        /* ========== PAUSE OVERLAY ========== */
        #pause-overlay {
            position: fixed;
            inset: 0;
            background: rgba(10, 10, 15, 0.95);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 50;
        }
        
        #pause-overlay.active {
            display: flex;
        }
        
        .pause-title {
            font-family: 'Orbitron', monospace;
            font-size: 3rem;
            margin-bottom: 40px;
            color: var(--neon-cyan);
        }
        
        .pause-btn-group {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .menu-button {
            font-family: 'Orbitron', monospace;
            font-size: 1.2rem;
            padding: 18px 50px;
            border-radius: 30px;
            border: 2px solid;
            background: transparent;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 2px;
        }
        
        .menu-button.primary {
            border-color: var(--neon-cyan);
            color: var(--neon-cyan);
        }
        
        .menu-button.primary:hover,
        .menu-button.primary:active {
            background: var(--neon-cyan);
            color: var(--bg-dark);
            box-shadow: 0 0 30px rgba(0, 245, 255, 0.5);
        }
        
        .menu-button.secondary {
            border-color: var(--neon-pink);
            color: var(--neon-pink);
        }
        
        .menu-button.secondary:hover,
        .menu-button.secondary:active {
            background: var(--neon-pink);
            color: var(--bg-dark);
            box-shadow: 0 0 30px rgba(255, 0, 170, 0.5);
        }
        
        /* ========== GAME OVER ========== */
        #gameover-overlay {
            position: fixed;
            inset: 0;
            background: rgba(10, 10, 15, 0.95);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 60;
        }
        
        #gameover-overlay.active {
            display: flex;
        }
        
        .gameover-title {
            font-family: 'Orbitron', monospace;
            font-size: 2.5rem;
            color: var(--neon-pink);
            margin-bottom: 10px;
            text-shadow: 0 0 30px rgba(255, 0, 170, 0.5);
        }
        
        .final-score {
            font-family: 'Orbitron', monospace;
            font-size: 4rem;
            font-weight: 900;
            color: var(--neon-cyan);
            margin-bottom: 10px;
        }
        
        .score-label {
            font-size: 1.2rem;
            color: rgba(255, 255, 255, 0.5);
            margin-bottom: 30px;
            text-transform: uppercase;
            letter-spacing: 3px;
        }
        
        .stats-row {
            display: flex;
            gap: 40px;
            margin-bottom: 40px;
        }
        
        .stat-item {
            text-align: center;
        }
        
        .stat-value {
            font-family: 'Orbitron', monospace;
            font-size: 2rem;
            font-weight: 700;
            color: var(--neon-green);
        }
        
        .stat-label {
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.4);
            text-transform: uppercase;
        }
        
        .new-record {
            font-family: 'Orbitron', monospace;
            font-size: 1.5rem;
            color: var(--neon-yellow);
            margin-bottom: 20px;
            animation: recordPulse 0.5s ease-in-out infinite alternate;
        }
        
        @keyframes recordPulse {
            from { opacity: 0.7; transform: scale(1); }
            to { opacity: 1; transform: scale(1.05); }
        }
        
        /* ========== COUNTDOWN ========== */
        #countdown {
            position: fixed;
            inset: 0;
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 70;
            background: rgba(10, 10, 15, 0.8);
        }
        
        #countdown.active {
            display: flex;
        }
        
        .countdown-number {
            font-family: 'Orbitron', monospace;
            font-size: 10rem;
            font-weight: 900;
            color: var(--neon-cyan);
            text-shadow: 0 0 60px rgba(0, 245, 255, 0.8);
            animation: countPop 0.5s ease-out;
        }
        
        @keyframes countPop {
            0% { transform: scale(2); opacity: 0; }
            50% { transform: scale(0.9); }
            100% { transform: scale(1); opacity: 1; }
        }
        
        /* ========== INSTRUCTIONS ========== */
        .instructions {
            position: absolute;
            bottom: 130px;
            left: 50%;
            transform: translateX(-50%);
            text-align: center;
            color: rgba(255, 255, 255, 0.3);
            font-size: 0.9rem;
            pointer-events: none;
            z-index: 3;
        }
        
        /* ========== SCROLLBAR ========== */
        .song-list::-webkit-scrollbar {
            width: 6px;
        }
        
        .song-list::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 3px;
        }
        
        .song-list::-webkit-scrollbar-thumb {
            background: rgba(0, 245, 255, 0.3);
            border-radius: 3px;
        }
        
        /* ========== PARTICLES ========== */
        .particle {
            position: fixed;
            pointer-events: none;
            border-radius: 50%;
            animation: particleFade 0.6s ease-out forwards;
        }
        
        @keyframes particleFade {
            0% { transform: translate(0, 0) scale(1); opacity: 1; }
            100% { transform: translate(var(--dx), var(--dy)) scale(0); opacity: 0; }
        }
    </style>
</head>
<body>
    <!-- Menu Screen -->
    <div id="menu-screen">
        <h1 class="menu-title">COCO KEYS</h1>
        <p class="menu-subtitle">Tap to the Beat</p>
        <div class="song-list" id="song-list"></div>
    </div>
    
    <!-- Game Screen -->
    <div id="game-screen">
        <div class="game-header">
            <div>
                <div class="score-display" id="score">0</div>
                <div class="combo-display" id="combo">COMBO x1</div>
            </div>
            <button class="pause-btn" id="pause-btn">❚❚</button>
        </div>
        <div class="game-area" id="game-area">
            <div class="lanes-container" id="lanes-container">
                <div class="lane" data-lane="0"><div class="lane-glow"></div></div>
                <div class="lane" data-lane="1"><div class="lane-glow"></div></div>
                <div class="lane" data-lane="2"><div class="lane-glow"></div></div>
                <div class="lane" data-lane="3"><div class="lane-glow"></div></div>
            </div>
            <div class="hit-line"></div>
            <div class="hit-zone" id="hit-zone">
                <div class="hit-zone-lane" data-lane="0"></div>
                <div class="hit-zone-lane" data-lane="1"></div>
                <div class="hit-zone-lane" data-lane="2"></div>
                <div class="hit-zone-lane" data-lane="3"></div>
            </div>
            <div class="instructions">TAP THE TILES AS THEY HIT THE LINE</div>
        </div>
    </div>
    
    <!-- Pause Overlay -->
    <div id="pause-overlay">
        <h2 class="pause-title">PAUSED</h2>
        <div class="pause-btn-group">
            <button class="menu-button primary" id="resume-btn">RESUME</button>
            <button class="menu-button secondary" id="quit-btn">QUIT</button>
        </div>
    </div>
    
    <!-- Game Over Overlay -->
    <div id="gameover-overlay">
        <h2 class="gameover-title">GAME OVER</h2>
        <div class="final-score" id="final-score">0</div>
        <div class="score-label">FINAL SCORE</div>
        <div class="new-record" id="new-record" style="display: none;">★ NEW RECORD ★</div>
        <div class="stats-row">
            <div class="stat-item">
                <div class="stat-value" id="tiles-hit">0</div>
                <div class="stat-label">Tiles Hit</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="max-combo">0</div>
                <div class="stat-label">Max Combo</div>
            </div>
        </div>
        <div class="pause-btn-group">
            <button class="menu-button primary" id="retry-btn">RETRY</button>
            <button class="menu-button secondary" id="menu-btn">MENU</button>
        </div>
    </div>
    
    <!-- Countdown -->
    <div id="countdown">
        <div class="countdown-number" id="countdown-number">3</div>
    </div>

    <script>
        // ==================== AUDIO ENGINE ====================
        class AudioEngine {
            constructor() {
                this.ctx = null;
                this.initialized = false;
            }
            
            init() {
                if (this.initialized) return;
                this.ctx = new (window.AudioContext || window.webkitAudioContext)();
                this.initialized = true;
            }
            
            // Piano note frequencies (C4 to B5 - two octaves)
            getNoteFrequency(noteIndex) {
                const notes = [
                    261.63, 293.66, 329.63, 349.23, 392.00, 440.00, 493.88, // C4-B4
                    523.25, 587.33, 659.25, 698.46, 783.99, 880.00, 987.77, // C5-B5
                    1046.50 // C6
                ];
                return notes[noteIndex % notes.length];
            }
            
            playNote(noteIndex, duration = 0.3) {
                if (!this.ctx) return;
                
                const freq = this.getNoteFrequency(noteIndex);
                const now = this.ctx.currentTime;
                
                // Create oscillators for rich piano-like sound
                const osc1 = this.ctx.createOscillator();
                const osc2 = this.ctx.createOscillator();
                const gainNode = this.ctx.createGain();
                const filter = this.ctx.createBiquadFilter();
                
                osc1.type = 'triangle';
                osc1.frequency.value = freq;
                
                osc2.type = 'sine';
                osc2.frequency.value = freq * 2;
                
                filter.type = 'lowpass';
                filter.frequency.value = 2000;
                filter.Q.value = 1;
                
                // ADSR envelope
                gainNode.gain.setValueAtTime(0, now);
                gainNode.gain.linearRampToValueAtTime(0.4, now + 0.01);
                gainNode.gain.exponentialRampToValueAtTime(0.2, now + 0.1);
                gainNode.gain.exponentialRampToValueAtTime(0.01, now + duration);
                
                osc1.connect(filter);
                osc2.connect(filter);
                filter.connect(gainNode);
                gainNode.connect(this.ctx.destination);
                
                osc1.start(now);
                osc2.start(now);
                osc1.stop(now + duration);
                osc2.stop(now + duration);
            }
            
            playMiss() {
                if (!this.ctx) return;
                
                const now = this.ctx.currentTime;
                const osc = this.ctx.createOscillator();
                const gainNode = this.ctx.createGain();
                
                osc.type = 'sawtooth';
                osc.frequency.value = 80;
                
                gainNode.gain.setValueAtTime(0.3, now);
                gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.3);
                
                osc.connect(gainNode);
                gainNode.connect(this.ctx.destination);
                
                osc.start(now);
                osc.stop(now + 0.3);
            }
        }
        
        // ==================== SONG DATA ====================
        // Each song has notes: [lane (0-3), time offset in beats, noteIndex for sound]
        const SONGS = [
            {
                id: 'twinkle',
                name: 'Twinkle Twinkle',
                composer: 'Traditional',
                difficulty: 'easy',
                bpm: 100,
                notes: [
                    [0, 0, 0], [0, 1, 0], [2, 2, 4], [2, 3, 4],
                    [3, 4, 5], [3, 5, 5], [2, 6, 4], 
                    [1, 8, 3], [1, 9, 3], [0, 10, 2], [0, 11, 2],
                    [3, 12, 1], [3, 13, 1], [2, 14, 0],
                    [2, 16, 4], [2, 17, 4], [1, 18, 3], [1, 19, 3],
                    [0, 20, 2], [0, 21, 2], [3, 22, 1],
                    [2, 24, 4], [2, 25, 4], [1, 26, 3], [1, 27, 3],
                    [0, 28, 2], [0, 29, 2], [3, 30, 1],
                    [0, 32, 0], [0, 33, 0], [2, 34, 4], [2, 35, 4],
                    [3, 36, 5], [3, 37, 5], [2, 38, 4],
                    [1, 40, 3], [1, 41, 3], [0, 42, 2], [0, 43, 2],
                    [3, 44, 1], [3, 45, 1], [2, 46, 0]
                ]
            },
            {
                id: 'ode_to_joy',
                name: 'Ode to Joy',
                composer: 'Beethoven',
                difficulty: 'easy',
                bpm: 110,
                notes: [
                    [1, 0, 4], [1, 1, 4], [2, 2, 5], [3, 3, 6],
                    [3, 4, 6], [2, 5, 5], [1, 6, 4], [0, 7, 3],
                    [0, 8, 2], [0, 9, 2], [1, 10, 3], [1, 11, 4],
                    [1, 12, 4], [0, 13.5, 3], [0, 14, 3],
                    [1, 16, 4], [1, 17, 4], [2, 18, 5], [3, 19, 6],
                    [3, 20, 6], [2, 21, 5], [1, 22, 4], [0, 23, 3],
                    [0, 24, 2], [0, 25, 2], [1, 26, 3], [1, 27, 4],
                    [0, 28, 3], [0, 29.5, 2], [0, 30, 2],
                    [0, 32, 3], [0, 33, 3], [1, 34, 4], [0, 35, 2],
                    [1, 36, 3], [2, 37, 4], [2, 37.5, 5], [1, 38, 4], [0, 39, 2],
                    [1, 40, 3], [2, 41, 4], [2, 41.5, 5], [1, 42, 4], [1, 43, 3],
                    [0, 44, 2], [0, 45, 3], [3, 46, 0]
                ]
            },
            {
                id: 'fur_elise',
                name: 'Für Elise',
                composer: 'Beethoven',
                difficulty: 'medium',
                bpm: 130,
                notes: [
                    [3, 0, 9], [2, 0.5, 8], [3, 1, 9], [2, 1.5, 8], [3, 2, 9],
                    [1, 2.5, 6], [2, 3, 8], [0, 3.5, 5], [0, 4, 4],
                    [0, 5, 0], [1, 5.5, 2], [0, 6, 4], [1, 6.5, 6],
                    [2, 7, 8], [1, 8, 4], [2, 8.5, 7], [1, 9, 6],
                    [2, 9.5, 8], [3, 10, 9], [2, 10.5, 8], [3, 11, 9],
                    [2, 11.5, 8], [3, 12, 9], [1, 12.5, 6], [2, 13, 8],
                    [0, 13.5, 5], [0, 14, 4],
                    [0, 15, 0], [1, 15.5, 2], [0, 16, 4], [2, 16.5, 6],
                    [1, 17, 5], [0, 17.5, 2], [0, 18, 4],
                    [1, 19, 5], [1, 19.5, 6], [2, 20, 7], [2, 20.5, 8],
                    [3, 21, 9], [1, 22, 7], [3, 22.5, 10], [3, 23, 9],
                    [2, 23.5, 8], [1, 24, 7], [2, 24.5, 8], [1, 25, 6],
                    [0, 25.5, 5], [1, 26, 6], [0, 26.5, 4], [0, 27, 5],
                    [1, 27.5, 6], [2, 28, 7]
                ]
            },
            {
                id: 'canon',
                name: 'Canon in D',
                composer: 'Pachelbel',
                difficulty: 'medium',
                bpm: 80,
                notes: [
                    [3, 0, 11], [2, 1, 9], [1, 2, 7], [0, 3, 4],
                    [0, 4, 2], [1, 5, 4], [2, 6, 7], [3, 7, 9],
                    [3, 8, 11], [3, 9, 11], [2, 10, 9], [2, 11, 9],
                    [1, 12, 7], [1, 13, 7], [0, 14, 4], [0, 15, 4],
                    [0, 16, 2], [0, 17, 2], [1, 18, 4], [1, 19, 4],
                    [2, 20, 7], [2, 21, 7], [3, 22, 9], [3, 23, 9],
                    [3, 24, 11], [2, 24.5, 9], [3, 25, 11], [2, 25.5, 9],
                    [2, 26, 9], [1, 26.5, 7], [2, 27, 9], [1, 27.5, 7],
                    [1, 28, 7], [0, 28.5, 4], [1, 29, 7], [0, 29.5, 4],
                    [0, 30, 4], [0, 30.5, 2], [0, 31, 4], [1, 31.5, 7],
                    [0, 32, 2], [1, 32.5, 4], [0, 33, 2], [1, 33.5, 4],
                    [1, 34, 4], [2, 34.5, 7], [1, 35, 4], [2, 35.5, 7],
                    [2, 36, 7], [3, 36.5, 9], [2, 37, 7], [3, 37.5, 9],
                    [3, 38, 9], [3, 38.5, 11], [3, 39, 9], [2, 39.5, 7]
                ]
            },
            {
                id: 'moonlight',
                name: 'Moonlight Sonata',
                composer: 'Beethoven',
                difficulty: 'hard',
                bpm: 140,
                notes: [
                    [0, 0, 0], [1, 0.33, 4], [2, 0.66, 7],
                    [0, 1, 0], [1, 1.33, 4], [2, 1.66, 7],
                    [0, 2, 0], [1, 2.33, 4], [2, 2.66, 7],
                    [0, 3, 0], [1, 3.33, 4], [2, 3.66, 7],
                    [3, 4, 8], [1, 4.33, 4], [2, 4.66, 7],
                    [3, 5, 9], [1, 5.33, 4], [2, 5.66, 7],
                    [3, 6, 8], [1, 6.33, 4], [2, 6.66, 7],
                    [0, 7, 0], [1, 7.33, 4], [2, 7.66, 7],
                    [0, 8, 2], [1, 8.33, 5], [2, 8.66, 9],
                    [0, 9, 2], [1, 9.33, 5], [2, 9.66, 9],
                    [0, 10, 2], [1, 10.33, 5], [2, 10.66, 9],
                    [0, 11, 2], [1, 11.33, 5], [2, 11.66, 9],
                    [3, 12, 11], [1, 12.33, 5], [2, 12.66, 9],
                    [3, 13, 12], [1, 13.33, 5], [2, 13.66, 9],
                    [3, 14, 11], [1, 14.33, 5], [2, 14.66, 9],
                    [3, 15, 9], [1, 15.33, 5], [2, 15.66, 7],
                    [0, 16, 0], [1, 16.33, 3], [2, 16.66, 7],
                    [0, 17, 0], [1, 17.33, 3], [2, 17.66, 7],
                    [3, 18, 8], [1, 18.33, 4], [2, 18.66, 7],
                    [3, 19, 7], [1, 19.33, 3], [2, 19.66, 5],
                    [0, 20, 0], [1, 20.33, 4], [2, 20.66, 7],
                    [0, 21, 2], [1, 21.33, 5], [2, 21.66, 9],
                    [3, 22, 11], [2, 22.33, 9], [1, 22.66, 7],
                    [0, 23, 4], [1, 23.33, 5], [2, 23.66, 7]
                ]
            },
            {
                id: 'entertainer',
                name: 'The Entertainer',
                composer: 'Scott Joplin',
                difficulty: 'hard',
                bpm: 150,
                notes: [
                    [2, 0, 3], [3, 0.5, 4], [2, 1, 3], [3, 1.5, 4],
                    [2, 2, 3], [1, 2.5, 0], [0, 3, 2], [1, 3.5, 3],
                    [2, 4, 4], [1, 5, 3], [0, 6, 2], [1, 6.5, 3],
                    [2, 7, 4], [3, 7.5, 7], [3, 8, 6], [2, 8.5, 4],
                    [1, 9, 3], [2, 9.5, 4], [3, 10, 6], [2, 10.5, 4],
                    [1, 11, 3], [0, 11.5, 2], [0, 12, 0],
                    [2, 13, 3], [3, 13.5, 4], [2, 14, 3], [3, 14.5, 4],
                    [2, 15, 3], [1, 15.5, 0], [0, 16, 2], [1, 16.5, 3],
                    [2, 17, 4], [3, 18, 7], [3, 18.5, 9], [2, 19, 7],
                    [1, 19.5, 6], [2, 20, 7], [3, 20.5, 9], [2, 21, 7],
                    [1, 21.5, 6], [0, 22, 4], [1, 22.5, 6], [2, 23, 7],
                    [3, 24, 9], [2, 24.5, 7], [1, 25, 6], [2, 25.5, 7],
                    [3, 26, 9], [3, 26.5, 11], [2, 27, 9], [1, 27.5, 7],
                    [0, 28, 6], [1, 28.5, 7], [2, 29, 9], [3, 29.5, 11],
                    [3, 30, 12], [2, 30.5, 9], [1, 31, 7], [0, 31.5, 4]
                ]
            },
            {
                id: 'mary_lamb',
                name: 'Mary Had a Little Lamb',
                composer: 'Traditional',
                difficulty: 'easy',
                bpm: 100,
                notes: [
                    [2, 0, 4], [1, 1, 3], [0, 2, 2], [1, 3, 3],
                    [2, 4, 4], [2, 5, 4], [2, 6, 4],
                    [1, 8, 3], [1, 9, 3], [1, 10, 3],
                    [2, 12, 4], [3, 13, 6], [3, 14, 6],
                    [2, 16, 4], [1, 17, 3], [0, 18, 2], [1, 19, 3],
                    [2, 20, 4], [2, 21, 4], [2, 22, 4], [2, 23, 4],
                    [1, 24, 3], [1, 25, 3], [2, 26, 4], [1, 27, 3],
                    [0, 28, 2]
                ]
            },
            {
                id: 'jingle_bells',
                name: 'Jingle Bells',
                composer: 'Traditional',
                difficulty: 'easy',
                bpm: 120,
                notes: [
                    [2, 0, 4], [2, 1, 4], [2, 2, 4],
                    [2, 4, 4], [2, 5, 4], [2, 6, 4],
                    [2, 8, 4], [3, 9, 6], [0, 10, 0], [1, 11, 2],
                    [2, 12, 4],
                    [1, 14, 3], [1, 15, 3], [1, 16, 3], [1, 17, 3],
                    [1, 18, 3], [2, 19, 4], [2, 20, 4], [2, 21, 4], [2, 21.5, 4],
                    [2, 22, 4], [1, 23, 2], [1, 24, 2], [3, 25, 6],
                    [3, 26, 6], [1, 27, 2], [0, 28, 0],
                    [2, 30, 4], [2, 31, 4], [2, 32, 4],
                    [2, 34, 4], [2, 35, 4], [2, 36, 4],
                    [2, 38, 4], [3, 39, 6], [0, 40, 0], [1, 41, 2],
                    [2, 42, 4],
                    [1, 44, 3], [1, 45, 3], [1, 46, 3], [1, 47, 3],
                    [1, 48, 3], [2, 49, 4], [2, 50, 4], [2, 51, 4],
                    [3, 52, 6], [3, 53, 6], [2, 54, 4], [1, 55, 2],
                    [0, 56, 0]
                ]
            }
        ];
        
        // ==================== GAME ENGINE ====================
        class PianoTilesGame {
            constructor() {
                this.audio = new AudioEngine();
                this.currentSong = null;
                this.tiles = [];
                this.score = 0;
                this.combo = 0;
                this.maxCombo = 0;
                this.tilesHit = 0;
                this.isPlaying = false;
                this.isPaused = false;
                this.gameOver = false;
                this.startTime = 0;
                this.tileSpeed = 400; // pixels per second
                this.tileHeight = 120;
                this.hitZoneTop = 0;
                this.hitZoneBottom = 0;
                this.nextTileIndex = 0;
                this.lastFrameTime = 0;
                
                this.initElements();
                this.initEventListeners();
                this.renderSongList();
                this.loadHighScores();
            }
            
            initElements() {
                this.menuScreen = document.getElementById('menu-screen');
                this.gameScreen = document.getElementById('game-screen');
                this.pauseOverlay = document.getElementById('pause-overlay');
                this.gameoverOverlay = document.getElementById('gameover-overlay');
                this.countdown = document.getElementById('countdown');
                this.countdownNumber = document.getElementById('countdown-number');
                
                this.scoreDisplay = document.getElementById('score');
                this.comboDisplay = document.getElementById('combo');
                this.finalScore = document.getElementById('final-score');
                this.tilesHitDisplay = document.getElementById('tiles-hit');
                this.maxComboDisplay = document.getElementById('max-combo');
                this.newRecord = document.getElementById('new-record');
                
                this.gameArea = document.getElementById('game-area');
                this.lanesContainer = document.getElementById('lanes-container');
                this.hitZone = document.getElementById('hit-zone');
                this.lanes = document.querySelectorAll('.lane');
            }
            
            initEventListeners() {
                // Song selection
                document.getElementById('song-list').addEventListener('click', (e) => {
                    const card = e.target.closest('.song-card');
                    if (card) {
                        const songId = card.dataset.songId;
                        this.startGame(songId);
                    }
                });
                
                // Touch/click on hit zone
                this.hitZone.addEventListener('touchstart', (e) => this.handleTouch(e), { passive: false });
                this.hitZone.addEventListener('mousedown', (e) => this.handleClick(e));
                
                // Pause button
                document.getElementById('pause-btn').addEventListener('click', () => this.togglePause());
                document.getElementById('resume-btn').addEventListener('click', () => this.togglePause());
                document.getElementById('quit-btn').addEventListener('click', () => this.quitGame());
                
                // Game over buttons
                document.getElementById('retry-btn').addEventListener('click', () => this.retryGame());
                document.getElementById('menu-btn').addEventListener('click', () => this.quitGame());
                
                // Prevent scrolling on touch
                document.body.addEventListener('touchmove', (e) => {
                    if (this.isPlaying) e.preventDefault();
                }, { passive: false });
            }
            
            renderSongList() {
                const list = document.getElementById('song-list');
                list.innerHTML = SONGS.map(song => {
                    const highScore = this.getHighScore(song.id);
                    return `
                        <div class="song-card" data-song-id="${song.id}">
                            <div class="song-card-content">
                                <div class="song-name">${song.name}</div>
                                <div class="song-composer">${song.composer}</div>
                                <div class="song-meta">
                                    <span class="difficulty ${song.difficulty}">${song.difficulty}</span>
                                    <span class="bpm">${song.bpm} BPM</span>
                                    ${highScore > 0 ? `<span class="high-score">★ ${highScore}</span>` : ''}
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            }
            
            loadHighScores() {
                this.highScores = JSON.parse(localStorage.getItem('cocoKeysHighScores') || '{}');
            }
            
            saveHighScore(songId, score) {
                if (score > (this.highScores[songId] || 0)) {
                    this.highScores[songId] = score;
                    localStorage.setItem('cocoKeysHighScores', JSON.stringify(this.highScores));
                    return true;
                }
                return false;
            }
            
            getHighScore(songId) {
                return this.highScores[songId] || 0;
            }
            
            async startGame(songId) {
                this.audio.init();
                this.currentSong = SONGS.find(s => s.id === songId);
                if (!this.currentSong) return;
                
                // Reset game state
                this.score = 0;
                this.combo = 0;
                this.maxCombo = 0;
                this.tilesHit = 0;
                this.tiles = [];
                this.nextTileIndex = 0;
                this.gameOver = false;
                this.isPaused = false;
                
                // Calculate hit zone position
                const gameAreaRect = this.gameArea.getBoundingClientRect();
                this.hitZoneTop = gameAreaRect.height - 100;
                this.hitZoneBottom = gameAreaRect.height;
                
                // Calculate tile speed based on BPM
                this.tileSpeed = (this.currentSong.bpm / 60) * 200;
                
                // Show game screen
                this.menuScreen.classList.add('hidden');
                this.gameScreen.classList.add('active');
                
                // Update displays
                this.updateScore();
                this.updateCombo();
                
                // Clear any existing tiles
                this.lanesContainer.querySelectorAll('.tile').forEach(t => t.remove());
                
                // Countdown
                await this.showCountdown();
                
                // Start game loop
                this.isPlaying = true;
                this.startTime = performance.now();
                this.lastFrameTime = this.startTime;
                this.gameLoop();
            }
            
            async showCountdown() {
                this.countdown.classList.add('active');
                
                for (let i = 3; i >= 1; i--) {
                    this.countdownNumber.textContent = i;
                    this.countdownNumber.style.animation = 'none';
                    void this.countdownNumber.offsetWidth;
                    this.countdownNumber.style.animation = 'countPop 0.5s ease-out';
                    await this.delay(700);
                }
                
                this.countdownNumber.textContent = 'GO!';
                this.countdownNumber.style.color = 'var(--neon-green)';
                await this.delay(500);
                
                this.countdown.classList.remove('active');
                this.countdownNumber.style.color = 'var(--neon-cyan)';
            }
            
            delay(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }
            
            gameLoop() {
                if (!this.isPlaying || this.gameOver) return;
                if (this.isPaused) {
                    requestAnimationFrame(() => this.gameLoop());
                    return;
                }
                
                const now = performance.now();
                const deltaTime = (now - this.lastFrameTime) / 1000;
                this.lastFrameTime = now;
                
                const elapsedTime = (now - this.startTime) / 1000;
                const beatTime = (this.currentSong.bpm / 60);
                
                // Spawn new tiles
                this.spawnTiles(elapsedTime, beatTime);
                
                // Update tile positions
                this.updateTiles(deltaTime);
                
                // Check for missed tiles
                this.checkMissedTiles();
                
                // Check if song is complete
                if (this.nextTileIndex >= this.currentSong.notes.length && this.tiles.length === 0) {
                    this.endGame(true);
                    return;
                }
                
                requestAnimationFrame(() => this.gameLoop());
            }
            
            spawnTiles(elapsedTime, beatTime) {
                const gameAreaRect = this.gameArea.getBoundingClientRect();
                const spawnY = -this.tileHeight;
                const travelDistance = gameAreaRect.height;
                const travelTime = travelDistance / this.tileSpeed;
                
                while (this.nextTileIndex < this.currentSong.notes.length) {
                    const note = this.currentSong.notes[this.nextTileIndex];
                    const noteTime = note[1] / beatTime;
                    const spawnTime = noteTime - travelTime + (this.hitZoneTop / this.tileSpeed);
                    
                    if (elapsedTime >= spawnTime) {
                        const tile = {
                            id: this.nextTileIndex,
                            lane: note[0],
                            noteIndex: note[2],
                            y: spawnY,
                            targetTime: noteTime,
                            hit: false,
                            missed: false,
                            element: this.createTileElement(note[0])
                        };
                        this.tiles.push(tile);
                        this.nextTileIndex++;
                    } else {
                        break;
                    }
                }
            }
            
            createTileElement(lane) {
                const tile = document.createElement('div');
                tile.className = `tile lane-${lane}`;
                tile.style.height = `${this.tileHeight}px`;
                this.lanes[lane].appendChild(tile);
                return tile;
            }
            
            updateTiles(deltaTime) {
                const movement = this.tileSpeed * deltaTime;
                
                this.tiles.forEach(tile => {
                    if (!tile.hit && !tile.missed) {
                        tile.y += movement;
                        tile.element.style.top = `${tile.y}px`;
                    }
                });
            }
            
            checkMissedTiles() {
                this.tiles.forEach(tile => {
                    if (!tile.hit && !tile.missed && tile.y > this.hitZoneBottom) {
                        this.missTile(tile);
                    }
                });
            }
            
            handleTouch(e) {
                if (!this.isPlaying || this.isPaused || this.gameOver) return;
                e.preventDefault();
                
                Array.from(e.touches).forEach(touch => {
                    const lane = this.getLaneFromPosition(touch.clientX);
                    if (lane !== -1) {
                        this.tryHitTile(lane);
                    }
                });
            }
            
            handleClick(e) {
                if (!this.isPlaying || this.isPaused || this.gameOver) return;
                
                const lane = this.getLaneFromPosition(e.clientX);
                if (lane !== -1) {
                    this.tryHitTile(lane);
                }
            }
            
            getLaneFromPosition(x) {
                const hitZoneRect = this.hitZone.getBoundingClientRect();
                const relativeX = x - hitZoneRect.left;
                const laneWidth = hitZoneRect.width / 4;
                const lane = Math.floor(relativeX / laneWidth);
                return lane >= 0 && lane < 4 ? lane : -1;
            }
            
            tryHitTile(lane) {
                // Find the lowest tile in this lane that's in the hit zone
                const hitTile = this.tiles
                    .filter(t => t.lane === lane && !t.hit && !t.missed)
                    .filter(t => t.y + this.tileHeight > this.hitZoneTop - 50 && t.y < this.hitZoneBottom)
                    .sort((a, b) => b.y - a.y)[0];
                
                if (hitTile) {
                    this.hitTile(hitTile);
                } else {
                    // Tapped empty space - check if any tile should have been hit
                    const missedTile = this.tiles
                        .filter(t => t.lane === lane && !t.hit && !t.missed)
                        .filter(t => t.y > this.hitZoneTop - 100)
                        .sort((a, b) => b.y - a.y)[0];
                    
                    if (missedTile) {
                        this.missTile(missedTile);
                    }
                }
                
                // Visual feedback for lane tap
                this.lanes[lane].classList.add('hit');
                setTimeout(() => this.lanes[lane].classList.remove('hit'), 100);
            }
            
            hitTile(tile) {
                tile.hit = true;
                tile.element.classList.add('hit');
                
                // Play note
                this.audio.playNote(tile.noteIndex, 0.4);
                
                // Update score
                this.combo++;
                this.maxCombo = Math.max(this.maxCombo, this.combo);
                this.tilesHit++;
                
                // Score based on combo
                const comboMultiplier = Math.min(1 + Math.floor(this.combo / 10) * 0.5, 3);
                this.score += Math.floor(100 * comboMultiplier);
                
                this.updateScore();
                this.updateCombo();
                
                // Particle effect
                this.createParticles(tile);
                
                // Remove tile after animation
                setTimeout(() => {
                    tile.element.remove();
                    const index = this.tiles.indexOf(tile);
                    if (index > -1) this.tiles.splice(index, 1);
                }, 200);
            }
            
            missTile(tile) {
                tile.missed = true;
                tile.element.classList.add('missed');
                
                this.audio.playMiss();
                this.combo = 0;
                this.updateCombo();
                
                // Game over on miss
                this.endGame(false);
            }
            
            createParticles(tile) {
                const rect = tile.element.getBoundingClientRect();
                const colors = ['var(--lane-1)', 'var(--lane-2)', 'var(--lane-3)', 'var(--lane-4)'];
                
                for (let i = 0; i < 8; i++) {
                    const particle = document.createElement('div');
                    particle.className = 'particle';
                    particle.style.left = `${rect.left + rect.width / 2}px`;
                    particle.style.top = `${rect.top + rect.height / 2}px`;
                    particle.style.width = '8px';
                    particle.style.height = '8px';
                    particle.style.background = colors[tile.lane];
                    particle.style.setProperty('--dx', `${(Math.random() - 0.5) * 100}px`);
                    particle.style.setProperty('--dy', `${(Math.random() - 0.5) * 100}px`);
                    document.body.appendChild(particle);
                    
                    setTimeout(() => particle.remove(), 600);
                }
            }
            
            updateScore() {
                this.scoreDisplay.textContent = this.score;
            }
            
            updateCombo() {
                if (this.combo > 1) {
                    this.comboDisplay.textContent = `COMBO x${this.combo}`;
                    this.comboDisplay.classList.add('active');
                } else {
                    this.comboDisplay.classList.remove('active');
                }
            }
            
            togglePause() {
                this.isPaused = !this.isPaused;
                this.pauseOverlay.classList.toggle('active', this.isPaused);
                
                if (!this.isPaused) {
                    this.lastFrameTime = performance.now();
                }
            }
            
            endGame(completed) {
                this.isPlaying = false;
                this.gameOver = true;
                
                // Check for high score
                const isNewRecord = this.saveHighScore(this.currentSong.id, this.score);
                
                // Update display
                this.finalScore.textContent = this.score;
                this.tilesHitDisplay.textContent = this.tilesHit;
                this.maxComboDisplay.textContent = this.maxCombo;
                this.newRecord.style.display = isNewRecord ? 'block' : 'none';
                
                // Show game over screen
                setTimeout(() => {
                    this.gameoverOverlay.classList.add('active');
                }, 500);
            }
            
            retryGame() {
                this.gameoverOverlay.classList.remove('active');
                this.lanesContainer.querySelectorAll('.tile').forEach(t => t.remove());
                this.startGame(this.currentSong.id);
            }
            
            quitGame() {
                this.isPlaying = false;
                this.gameOver = true;
                
                this.gameScreen.classList.remove('active');
                this.pauseOverlay.classList.remove('active');
                this.gameoverOverlay.classList.remove('active');
                this.menuScreen.classList.remove('hidden');
                
                this.lanesContainer.querySelectorAll('.tile').forEach(t => t.remove());
                this.renderSongList(); // Refresh to show updated high scores
            }
        }
        
        // Initialize game
        const game = new PianoTilesGame();
        
        // Register service worker for PWA
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js').catch(() => {});
        }
    </script>
</body>
</html>
